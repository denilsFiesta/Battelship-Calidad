<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>User.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Battleship-project</a> &gt; <a href="index.source.html" class="el_package">com.model.game.user</a> &gt; <span class="el_source">User.java</span></div><h1>User.java</h1><pre class="source lang-java linenums">package com.model.game.user;

import com.model.game.AttackReport;
import com.model.game.FiringMode;
import com.model.game.Game;
import com.model.game.ocean.Point;
import com.model.ships.Ship;

import java.util.ArrayList;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.stream.Collectors;

public class User implements StatusChangedListener {
    private int actionsCounter;
    private UserState actualState;
    private Game currentSession;

    /**
     * this list is used only when game mode contains recovery ships mode
     * list stores the last attacking reports, which must be canceled in the event of a miss after a hit.
     */
    private List&lt;AttackReport&gt; lastReports;

<span class="fc" id="L25">    public User() {</span>
<span class="fc" id="L26">        this.actionsCounter = 0;</span>
<span class="fc" id="L27">        actualState = UserState.GENERAL;</span>
<span class="fc" id="L28">        lastReports = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L29">    }</span>

    /**
     * set current game session.
     *
     * @param game game
     */
    public void setCurrentSession(Game game) {
<span class="nc" id="L37">        currentSession = game;</span>
<span class="nc" id="L38">    }</span>

    /**
     * Hit on place in current game session.
     *
     * @param position position to attack
     * @param mode     firing mode
     * @return HitReport
     * @throws IllegalArgumentException if firing mode = torpedo and there is no available torpedo.
     */
    public AttackReport hitOnPlace(Point position, FiringMode mode) throws IllegalArgumentException {
<span class="nc" id="L49">        ++actionsCounter;</span>
<span class="nc" id="L50">        return currentSession.hitOnPlace(position, mode);</span>
    }

    /**
     * @return number of actions.
     */
    public int getActionsCounter() {
<span class="nc" id="L57">        return actionsCounter;</span>
    }

    /**
     * @return current game session.
     */
    public Game getCurrentSession() {
<span class="nc" id="L64">        return currentSession;</span>
    }

    /**
     * (for recovery ship mode only) depends on actual state:
     * if actualState == ATTACKING_SHIP and last attacking ship is not equal to current: undo recent actions.
     * if result of current attack = MISS and user was attacking ship in previous attacks: undo recent actions.
     * when the ship was sunk: clear all history
     * when the ship was firstly attacked remember this attack.
     *
     * @param report report of the current attack.
     */
    @Override
    public void onStatusChanged(AttackReport report) {
<span class="nc bnc" id="L78" title="All 4 branches missed.">        if (report.getResult() == AttackReport.HitResult.MISS &amp;&amp; lastReports.size() &gt; 0) {</span>
<span class="nc" id="L79">            undoRecentActions();</span>
<span class="nc" id="L80">            actualState = UserState.GENERAL;</span>
<span class="nc" id="L81">            lastReports.clear();</span>
<span class="nc" id="L82">            return;</span>
        }
<span class="nc bnc" id="L84" title="All 4 branches missed.">        if (actualState == UserState.ATTACKING_SHIP &amp;&amp; !lastShipIsEqualToCurrent(report.getShip())) {</span>
<span class="nc" id="L85">            undoRecentActions();</span>
<span class="nc" id="L86">            actualState = UserState.GENERAL;</span>
<span class="nc" id="L87">            lastReports.clear();</span>
<span class="nc" id="L88">            return;</span>
        }

<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (report.getResult() == AttackReport.HitResult.HIT) {</span>
<span class="nc" id="L92">            lastReports.add(report);</span>
<span class="nc" id="L93">            actualState = UserState.ATTACKING_SHIP;</span>
<span class="nc" id="L94">            return;</span>
        }

<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (report.getResult() == AttackReport.HitResult.SUNK) {</span>
<span class="nc" id="L98">            lastReports.clear();</span>
        }
<span class="nc" id="L100">    }</span>

    private boolean lastShipIsEqualToCurrent(Ship ship) {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (ship == null) return false;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (lastReports.size() &lt; 1) return false;</span>
<span class="nc" id="L105">        return ship.equals(lastReports.get(lastReports.size() - 1).getShip());</span>
    }


    private void undoRecentActions() {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (lastReports.size() &gt; 0) {</span>
            // remove duplicated attacks
<span class="nc" id="L112">            lastReports = new ArrayList&lt;&gt;(new LinkedHashSet&lt;&gt;(lastReports));</span>

            // restore health fleet in amount of the lastReports list size
<span class="nc" id="L115">            currentSession.restorePreviousHealthFleet(lastReports.size());</span>

            // restore ship health
<span class="nc" id="L118">            lastReports.get(0).getShip().restoreHealthInRecoveryMode();</span>

            // update points to recover (controller will update view if points not null)
<span class="nc" id="L121">            List&lt;Point&gt; pointsToRecover = lastReports.stream().map(AttackReport::getPosition).collect(Collectors.toList());</span>
<span class="nc" id="L122">            currentSession.updatePointsToRecover(pointsToRecover);</span>
        }
<span class="nc" id="L124">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>